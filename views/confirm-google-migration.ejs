<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/colors.css">
    <link rel="stylesheet" href="/login.css">
    <style>
        .confirm-card {
            max-width: 600px;
            margin: 0 auto;
        }
        .user-info-box {
            background-color: var(--color-primary);
            color: var(--color-white);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--color-secondary-2);
        }
        .user-info-box .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .user-info-box .info-item:last-child {
            margin-bottom: 0;
        }
        .user-info-box .info-item i {
            font-size: 1.2rem;
            margin-right: 0.75rem;
            width: 24px;
            text-align: center;
        }
        .warning-box {
            background-color: var(--color-accent);
            border-left: 4px solid var(--color-primary);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1.5rem;
        }
        .warning-box ul {
            margin-bottom: 0;
            padding-left: 1.5rem;
        }
        .warning-box li {
            margin-bottom: 0.5rem;
            color: var(--color-text);
        }
        .btn-confirm {
            background-color: var(--color-primary);
            border: none;
            color: var(--color-white);
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
        }
        .btn-confirm:hover {
            background-color: var(--color-primary);
            opacity: 0.9;
            color: var(--color-white);
        }
        .google-icon-large {
            color: #4285F4;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-md-10 col-lg-8">
                    <div class="login-card confirm-card">
                        <div class="text-center mb-4">
                            <div class="mb-3">
                                <i class="bi bi-google google-icon-large" style="font-size: 3rem;"></i>
                            </div>
                            <h1 class="login-title" style="font-size: 1.75rem;"><%= title %></h1>
                            <p class="text-muted">พบบัญชีที่ใช้อีเมลนี้อยู่แล้วในระบบ</p>
                        </div>

                        <!-- User Information Box -->
                        <div class="user-info-box">
                            <h5 class="mb-3">
                                <i class="bi bi-person-circle me-2"></i>ข้อมูลบัญชีของคุณ
                            </h5>
                            <div class="info-item">
                                <i class="bi bi-card-text"></i>
                                <span><strong>รหัสนักศึกษา:</strong> <%= userData.studentId %></span>
                            </div>
                            <div class="info-item">
                                <i class="bi bi-person"></i>
                                <span><strong>ชื่อ-นามสกุล:</strong> <%= userData.prefix %><%= userData.firstName %> <%= userData.lastName %></span>
                            </div>
                            <div class="info-item">
                                <i class="bi bi-envelope"></i>
                                <span><strong>อีเมล:</strong> <%= email %></span>
                            </div>
                        </div>

                        <!-- Warning Box -->
                        <div class="warning-box">
                            <h6 class="mb-2" style="color: var(--color-primary);">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>หากคุณเลือกเชื่อมต่อกับ Google:
                            </h6>
                            <ul>
                                <li>คุณจะเข้าสู่ระบบด้วย Google OAuth แทนรหัสผ่านเดิม</li>
                                <li>รหัสผ่านเดิมของคุณจะถูกลบออกจากระบบ</li>
                                <li>คุณจะต้องใช้ Google เพื่อเข้าสู่ระบบตลอดไป</li>
                                <li>หากต้องการใช้รหัสผ่านอีกครั้ง คุณสามารถตั้งค่าในหน้า Settings ได้ภายหลัง</li>
                            </ul>
                        </div>

                        <!-- Confirmation Question -->
                        <div class="alert alert-info">
                            <h6 class="mb-2">
                                <i class="bi bi-question-circle me-2"></i>คุณต้องการเชื่อมต่อบัญชีนี้กับ Google หรือไม่?
                            </h6>
                            <p class="mb-0 small">หากเลือก "ยืนยัน" คุณจะเข้าสู่ระบบและเปลี่ยนเป็นการเข้าผ่าน Google ทันที</p>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-3">
                            <button type="button" class="btn btn-confirm btn-lg" id="confirmBtn">
                                <i class="bi bi-check-circle me-2"></i>ยืนยัน เชื่อมต่อกับ Google
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg" id="cancelBtn">
                                <i class="bi bi-x-circle me-2"></i>ยกเลิก กลับไปหน้าเข้าสู่ระบบ
                            </button>
                        </div>

                        <div class="text-center mt-4">
                            <p class="text-muted small">
                                <i class="bi bi-shield-check me-1"></i>
                                ข้อมูลของคุณปลอดภัยและได้รับการเข้ารหัส
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.getElementById('confirmBtn').addEventListener('click', async function() {
            Swal.fire({
                title: 'กำลังเชื่อมต่อ...',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch('/auth/confirm-google-migration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ confirm: 'yes' })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'เชื่อมต่อสำเร็จ!',
                        text: 'บัญชีของคุณได้เชื่อมต่อกับ Google แล้ว',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    window.location.href = result.redirectUrl;
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: result.error || 'ไม่สามารถเชื่อมต่อบัญชีได้',
                        confirmButtonText: 'ตกลง'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์',
                    confirmButtonText: 'ตกลง'
                });
            }
        });

        document.getElementById('cancelBtn').addEventListener('click', async function() {
            const result = await Swal.fire({
                title: 'ยกเลิกการเชื่อมต่อ?',
                text: 'คุณจะกลับไปหน้าเข้าสู่ระบบ',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ใช่ ยกเลิก',
                cancelButtonText: 'ไม่'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch('/auth/confirm-google-migration', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ confirm: 'no' })
                    });

                    const data = await response.json();
                    window.location.href = data.redirectUrl || '/login';
                } catch (error) {
                    window.location.href = '/login';
                }
            }
        });
    </script>
</body>

</html>
