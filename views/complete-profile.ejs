<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
        <%= title %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/colors.css">
    <link rel="stylesheet" href="/register.css">
</head>

<body>
    <div class="register-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-md-8 col-lg-6">
                    <div class="register-card">
                        <div class="text-center mb-4">
                            <div class="mb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor"
                                    class="bi bi-person-check text-success" viewBox="0 0 16 16">
                                    <path
                                        d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m1.679-4.493-1.335 2.226a.75.75 0 0 1-1.174.144l-.774-.773a.5.5 0 0 1 .708-.708l.547.548 1.17-1.951a.5.5 0 1 1 .858.514M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4" />
                                    <path
                                        d="M8.256 14a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1z" />
                                </svg>
                            </div>
                            <h1 class="register-title">
                                <%= title %>
                            </h1>
                            <p class="text-muted">กรอกข้อมูลเพิ่มเติมเพื่อใช้งานระบบ</p>
                            <div class="alert alert-info">
                                <strong>ยินดีต้อนรับ!</strong> <%= userData.firstName %> <%= userData.lastName %><br>
                                <small>อีเมล: <%= userData.email %></small>
                            </div>
                        </div>

                        <form action="/register/complete-profile" method="POST" class="register-form"
                            id="completeProfileForm">
                            <!-- รหัสนักศึกษา -->
                            <div class="mb-3">
                                <label for="studentId" class="form-label">รหัสนักศึกษา <span class="text-danger">*</span></label>
                                <input type="text" id="studentId" name="studentId" class="form-control" placeholder="กรอกรหัสนักศึกษา" value="<%= userData.studentId || '' %>" required>
                                <div class="form-text">สำหรับอาจารย์ สามารถกรอกเป็นรหัสภายในได้</div>
                            </div>

                            <!-- คำนำหน้า -->
                            <div class="mb-3">
                                <label for="prefix" class="form-label">คำนำหน้า <span
                                        class="text-danger">*</span></label>
                                <select id="prefix" name="prefix" class="form-select" required>
                                    <option value="">เลือกคำนำหน้า</option>
                                    <option value="นาย">นาย</option>
                                    <option value="นางสาว">นางสาว</option>
                                    <option value="นาง">นาง</option>
                                </select>
                            </div>

                            <!-- วันเดือนปีเกิด และ อายุ -->
                            <div class="row g-3 mb-3">
                                <div class="col-12 col-sm-8">
                                    <label for="birthdate" class="form-label">วันเดือนปีเกิด <span
                                            class="text-danger">*</span></label>
                                    <input type="date" id="birthdate" name="birthdate" class="form-control" required>
                                    <div id="birthdateThai" class="form-text text-muted mt-1">(ปี พ.ศ. จะแสดงที่นี่)
                                    </div>
                                </div>
                                <div class="col-12 col-sm-4">
                                    <label for="age" class="form-label">อายุ</label>
                                    <input type="number" id="age" name="age" class="form-control" placeholder="อายุ"
                                        readonly>
                                </div>
                            </div>

                            <!-- เบอร์โทรศัพท์ -->
                            <div class="mb-4">
                                <label for="phone" class="form-label">เบอร์โทรศัพท์ <span
                                        class="text-danger">*</span></label>
                                <input type="tel" id="phone" name="phone" class="form-control"
                                    placeholder="0xx-xxx-xxxx" required>
                            </div>

                            <!-- Submit button -->
                            <button type="submit" class="btn btn-primary w-100 mb-3 btn-lg">บันทึกข้อมูลและเริ่มใช้งาน</button>

                            <!-- Link to logout -->
                            <div class="text-center">
                                <p class="mb-0"><a href="/logout" class="text-secondary">ยกเลิกและออกจากระบบ</a></p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Calculate age from birthdate
        document.getElementById('birthdate').addEventListener('change', function () {
            const birthDate = new Date(this.value);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            document.getElementById('age').value = age >= 0 ? age : '';
        });

        // Show Thai Buddhist year (พ.ศ.) for birthdate and calculate age
        function formatDateToThai(birthDate) {
            if (!birthDate || isNaN(birthDate.getTime())) return '';
            const d = String(birthDate.getDate()).padStart(2, '0');
            const m = String(birthDate.getMonth() + 1).padStart(2, '0');
            const by = birthDate.getFullYear() + 543; // พ.ศ.
            return `${d}/${m}/${by}`;
        }

        const birthInput = document.getElementById('birthdate');
        const birthThaiEl = document.getElementById('birthdateThai');

        function updateAgeAndThai() {
            const val = birthInput.value;
            if (!val) {
                birthThaiEl.textContent = '(ปี พ.ศ. จะแสดงที่นี่)';
                document.getElementById('age').value = '';
                return;
            }
            const birthDate = new Date(val);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            document.getElementById('age').value = age >= 0 ? age : '';
            birthThaiEl.textContent = 'วันเกิด (พ.ศ.): ' + formatDateToThai(birthDate);
        }

        birthInput.addEventListener('change', updateAgeAndThai);

        // Form submission
        document.getElementById('completeProfileForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const ageVal = parseInt(document.getElementById('age').value, 10);
            if (isNaN(ageVal)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกวันเกิด',
                    text: 'โปรดระบุวัน/เดือน/ปีเกิดของคุณเพื่อคำนวณอายุ',
                    confirmButtonText: 'ตกลง'
                });
                return;
            }

            if (ageVal < 18) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สามารถดำเนินการได้',
                    html: `<p>ขออภัย คุณต้องมีอายุตั้งแต่ 18 ปีขึ้นไปเพื่อใช้งานระบบ</p>
                           <p>อายุตอนนี้: <strong>${ageVal}</strong> ปี</p>`,
                    confirmButtonText: 'ตกลง'
                });
                return;
            }

            // Get form data
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            // Show loading
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                text: 'โปรดรอสักครู่',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch('/register/complete-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกข้อมูลสำเร็จ!',
                        text: result.message || 'ยินดีต้อนรับเข้าสู่ระบบ',
                        confirmButtonText: 'เริ่มใช้งาน',
                        allowOutsideClick: false,
                        timer: 2000,
                        timerProgressBar: true
                    }).then(() => {
                        window.location.href = result.redirectUrl || '/survey/home';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: result.error || 'ไม่สามารถบันทึกข้อมูลได้',
                        confirmButtonText: 'ตกลง'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์',
                    confirmButtonText: 'ตกลง'
                });
            }
        });
    </script>
</body>

</html>
